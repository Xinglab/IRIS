#!/bin/bash

SCRIPT_DIR=$(pwd)

# need to use the setup that conda init writes to .bashrc
source ${HOME}/.bashrc || exit 1

echo "checking conda"

# ** Must manually install conda first. **
# This script will create two conda environments (Python 2 and 3)
# and install dependencies to them.
# https://docs.conda.io/en/latest/miniconda.html
# https://repo.anaconda.com/miniconda/Miniconda2-latest-Linux-x86_64.sh
CONDA_ENV_NAME_2='iris2'
CONDA_ENV_NAME_3='iris3'

function EnsureConda() {
    local CONDA_ENV_NAME=$1
    local CONDA_PYTHON_VERSION=$2

    local CONDA_INSTALLED=$(conda info --envs | grep "^${CONDA_ENV_NAME} .*/${CONDA_ENV_NAME}$" | wc -l) || exit 1
    if [[ ${CONDA_INSTALLED} == 1 ]]
    then
        echo "using existing ${CONDA_ENV_NAME} conda environment"
    else
        echo "creating new conda environment: ${CONDA_ENV_NAME}"
        conda create --name ${CONDA_ENV_NAME} python=${CONDA_PYTHON_VERSION} || exit 1
    fi
}

EnsureConda ${CONDA_ENV_NAME_2} 2.7
EnsureConda ${CONDA_ENV_NAME_3} 3.6

# ** Must manually download IEDB tools version 2.15.5 to the IEDB directory. **
# download file to IEDB/IEDB_MHC_I-2.15.5.tar.gz
# This script will unpack and install the IEDB tools.
# http://tools.iedb.org/main/download/ -> MHC Class I -> previous version -> 2.15.5
echo
echo "checking IEDB dependency"

cd IEDB || exit 1

if [[ ! -d mhc_i ]]
then
    tar -xvf IEDB_MHC_I-2.15.5.tar.gz || exit 1
fi

cd mhc_i || exit 1

./configure || exit 1

cd ${SCRIPT_DIR} || exit 1

# This script will automatically download and build bedtools
# https://github.com/arq5x/bedtools2/releases
echo
echo "checking bedtools dependency"

if [[ ! -d bedtools ]]
then
    mkdir bedtools || exit 1
fi

cd bedtools || exit 1

if [[ ! -f bedtools-2.29.0.tar.gz ]]
then
    BEDTOOLS_URI="https://github.com/arq5x/bedtools2/releases/download/v2.29.0/bedtools-2.29.0.tar.gz"
    curl -L ${BEDTOOLS_URI} -o bedtools-2.29.0.tar.gz || exit 1
fi

if [[ ! -d bedtools2 ]]
then
    tar -xvf bedtools-2.29.0.tar.gz || exit 1
fi

cd bedtools2 || exit 1
make || exit 1

cd ${SCRIPT_DIR} || exit 1

echo
echo "checking python dependencies"

conda activate ${CONDA_ENV_NAME_2} || exit 1

pip install -r requirements.txt || exit 1

# TODO steps for downloading IRIS db
echo
echo "checking IRIS db dependency"

if [[ ! -d IRIS_data ]]
then
    tar -xvf IRIS_data.tgz || exit 1
fi

echo
echo "installing IRIS"

python setup.py install || exit 1

cd ${SCRIPT_DIR} || exit 1

conda deactivate || exit 1
